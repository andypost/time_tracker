<?php
/**
 * @file
 * Enables time tracking on comments.
 */

/**
 * Implementation of hook_perm().
 */
function time_tracker_timer_perm() {
  return array('view all timers');
}

/**
 * Implementation of hook_menu().
 *
 */
function time_tracker_timer_menu() {
  $items = array();

  return $items;
}

/**
 * Implementation of hook_nodeapi().
 */
function time_tracker_timer_nodeapi(&$node, $op) {
  switch ($op) {
    case 'view':
      if (casetracker_is_case($node->type)) {
        if (user_access('view all timers')) {
          $timer_results = db_query("SELECT * FROM {time_tracker_timer} WHERE nid = %d", $node->nid);
        } else {
          global $user;
          $timer_results = db_query("SELECT * FROM {time_tracker_timer} WHERE nid = %d AND uid = %d", $node->nid, $user->uid);
        }

        if($node->content)
        $node->content['casetracker_case_summary']['#value'] = $node->content['casetracker_case_summary']['#value'] . theme('time_tracker_timer_case_summary', $timer_results);
      }
    break;
  }
}

/**
 * Implementation of hook_theme().
 */
function time_tracker_timer_theme() {
  return array(
    'time_tracker_timer_case_summary' => array(),
  );
}

/**
 * Theme function for case_tracker cases.
 */
function theme_time_tracker_timer_case_summary($timer_results) {
  $rows = array();

  while ($timer = db_fetch_object($timer_results)) {
    $rows[] = array(t('Timer started on ' . date("F jS", $timer->start) . ' (' . (time()-$timer->start) . ')'));
  }

  return theme('table', NULL, $rows, array('class' => 'time_tracker_timer'));
}




















